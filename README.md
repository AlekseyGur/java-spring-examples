# spring-k8s-ingress

Заготовка для gateway на базе k8s-ingress + Spring Cloud Config и Eureka

## Так не делают

Обычно внутри кластера k8s не используется Eureka. А вместо Spring Cloud Config используется ConfigMap. Но если всё-таки очень хочется сделать именно так, то стоит учитывать проблемы, описанные далее.

### Проблема с именами подов и сервисов в k8s

Основная сложность использования Spring Cloud Config и Eureka внутри кластера k8s заключается в следующем: механизм обнаружения сервисов (Service Discovery) некорректно определяет адрес сервера конфигурации. Вместо ожидаемого имени сервиса config-server он предоставляет микросервисам полное имя пода вида config-server-c64f9887-7nn9f.

Это создает проблему, поскольку микросервисы не способны установить прямое соединение с именем пода config-server-c64f9887-7nn9f, так как доступ к нему ограничен на уровне сетевой конфигурации кластера.

Таким образом проблема затронет все механизмы, связанные с взаимодействием между сервисами, например, через Feign. Потому что (у ribbon и resilence4j) обращения к сервисам будет идти по имени пода, а не сервиса. Единственный способ преодолеть сложности - отключить эти механизмы и в Feign напрямую указывать url в настройках клиента:

```
@FeignClient(name = "second-service", url = "http://second-service" ...
```

### Переменные окружения

Стоит обратить внимание что нельзя в файла конфигов  программ спрнга писать свои переменные так:

```
defaultZone: ${discovery.server.url:"http://localhost:8888/eureka/"}
```

Лучше использовать верхний регистр с подчёркиваниями, потому что точки могут просто не восприниматься верно:

```
defaultZone: ${DISCOVERY_SERVER_URL:"http://localhost:8888/eureka/"}
```

Вторая проблема пользовательскими названия переменных состоит в том, что они могут совпасть с системными названиями. Поэтому стоит придумать ещё и префикс для них. Например:

CUSTOM_DISCOVERY_SERVER_URL